<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Bíblia Sagrada</title>
    <script src="./node_modules/jsonata/jsonata.js" charset="utf-8"></script>
    <script src="./node_modules/vue/dist/vue.js" charset="utf-8"></script>
    <script src="./node_modules/vue-resource/dist/vue-resource.js" charset="utf-8"></script>
</head>

<body>
    <h1>Bíblia Sagrada</h1>

    <div id="app">
        <div v-if="control.showBackButton">
            <a href="#" v-on:click.prevent="goToListBook">Voltar</a>
        </div>

        <ul v-if=control.showListBook>
            <li v-for="(book, index) in books">
                <a href="#" v-on:click.prevent="getBook(index)">{{book.book}}</a>
            </li>
        </ul>

        <div v-if="control.showChapterNumbers">
            <h2>{{control.selectedBook.title}}</h2>
            <p>
                <a href="#" v-for="chapterNum in book.chapterNumbers" style="margin: 0 2px" v-on:click.prevent="getText(control.selectedBook.index, chapterNum)">
                    <span v-if="control.boldChapter == parseInt(chapterNum)"><strong>{{chapterNum}}</strong></span>
                    <span v-else><span>{{chapterNum}}</span></span>
                </a>
            </p>
        </div>

        <div v-if="control.showChapterVerses">
            <p v-for="(verse, index) in book.chapterVerses">{{index}}. {{verse}}</p>
        </div>
    </div>
</body>

<script type="text/javascript">
    var bookVM = new Vue({
        el: '#app',
        data: {
            book: {
                verse: '',
                chapterNumbers: [],
                chapterVerses: []
            },
            books: {},
            control: {
                showListBook: true,
                showChapterNumbers: false,
                showBackButton: false,
                showChapterVerses: false,
                boldChapter: undefined,
                selectedBook: {}
            }
        },
        mounted: function() {
            var _this = this

            Promise.resolve(_this.parseData())
        },
        methods: {
            parseData: function() {
                var _this = this
                var p1 = new Promise(function(resolve, reject) {
                    _this.$http.get('./data/nvi.json').then((response) => {
                        resolve(JSON.parse(response.data))
                    }, (response) => {
                        reject(response.data)
                    })
                })

                p1.then(function(data) {
                    _this.books = data
                })
            },

            getBook: function(index) {
                var _this = this
                var result = jsonata('$[' + parseInt(index) + '].chapters').evaluate(_this.books)

                // Controllers
                _this.book.chapterNumbers = []
                _this.control.showListBook = false
                _this.control.showChapterNumbers = true
                _this.control.showBackButton = true
                _this.control.selectedBook = {
                    index: index,
                    title: _this.books[index].book
                }

                var i = 0
                for (var r in result) {
                    _this.book.chapterNumbers.push(i + 1)
                    i++
                }
            },

            getText: function(book, chapter) {
                var _this = this
                var result = jsonata('$[' + parseInt(book) + '].chapters[' + (parseInt(chapter) - 1) + ']').evaluate(_this.books)

                // Controllers
                _this.control.showChapterVerses = true
                _this.control.boldChapter = parseInt(chapter)

                _this.book.chapterVerses = result[chapter]
            },

            goToListBook: function() {
                var _this = this

                // Controllers
                _this.control.showListBook = true
                _this.control.showChapterNumbers = false
                _this.control.showBackButton = false
                _this.control.showChapterVerses = false
                _this.book.boldChapter = undefined
                _this.control.selectedBook = {}

                _this.parseData()
            }
        }
    })
</script>

</html>
